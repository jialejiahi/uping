# 需求

ping 是测试连通性和时延的工具,简单易用, 但有时候我们需要使用 udp 协议,不能用 icmp。

开源工具 nc, iperf,sockperf 等,可以测连通性和 vm2vm 场景的时延.

自研的工具,cliloop 提供了包长走步测试能力, hpnetgap 提供了测试断网时长的能力。

但上面的工具都没考虑负载均衡多个rs的场景,用起来也没ping那么简单直观。

因此开发一个测试工具 uping, 基本功能是测试 udp 连通性,并能够像系统自带的 ping 一样统计 rtt 时延。

同时满足如下需求:

1. 需要能够设置较小的时延参数

2. 需要能 bind 本地地址和端口

3. 需要能够指定探测包长

4. 需要对报文回复数量和时延进行统计

   需要统计: 无应答报文数量是多少, 平均应答时延是多少,最大应答时延是多少。

5. 需要适配 lb 负载均衡场景（一个 client 多个 server）

   有多于一个 server 应答时,需要统计每个 server 应答报文数量是多少,平均应答时延是多少,最大应答时延是多少。

6. 需要做一些基本的系统优化,比如调大 socket buffer 大小适配突发

7. 需要静态编译,方便安装使用


# 参数

客户端和服务端共享参数

| 参数 | 含义                                                     | 默认值  |
| ---- | -------------------------------------------------------- | ------- |
| -B   | 服务端绑定的地址,服务端可选,客户端必填                 | 0.0.0.0 |
| -P   | server 监听端口列表,格式 23456,23457                  | 23456,23457   |
| -d   | print level, 0 不打印,1 打印基本信息,2 是打印详细信息 | 1       |
| -h   | 打印帮助信息                                             |         |

服务端独有参数

| 参数 | 含义                                   | 默认值     |
| ---- | -------------------------------------- | ---------- |
| -s   | server 端,否则作为 client             | 服务端必填 |
| -n   | name, 负载均衡场景用于区分多个 server | hostname   |

客户端参数

| 参数 | 含义                                            | 默认值                 |
| ---- | ----------------------------------------------- | ---------------------- |
| -b   | bind 本地地址                                   | 默认 0.0.0.0, 不 bind |
| -p   | bind 本地端口                                   | 默认为 0,随机选择     |
| -m   | mutable ports 发包时使用不同源端口, 设置后-b无效 | 默认为 0,随机选择     |
| -l   | length, 负载的长度,最小取值 64 字节以容纳包头 | 64                     |
| -i   | interval, 发包间隔, 单位 ms                     | 100                    |
| -c   | count,发包数量                                 | 10                     |
| -t   | timeout, 一个报文无应答的超时时间,单位 ms     | 1000                   |

*注意： 时延测试的精度主要取决于发包间隔,因为程序处理时延的存在,实际发包间隔会略大于设置值*

examples：

```bash
# 1. 类似ping的简单使用方式, 客户端访问服务端的23456, 23457 接口
./uping -s &
./uping -B 127.0.0.1

# 配置lb监听器,ip地址10.0.32.172,端口13579
# 后端绑定两个rs, 10.0.32.75 10.0.32.178
# lb的两个rs server端分别监听两个端口
./uping -s -B 10.0.32.75 -P 22222,33333 -n server1
./uping -s -B 10.0.32.178 -P 22222,33333 -n server2

# client访问lb监听器的地址和端口,指定报文长度为256, 发送间隔1毫秒
./uping -B 10.0.32.172 -P 13579 -c 5000 -l 256 -t 1000 -i 1 -m
./uping -B 10.0.32.172 -P 13579 -c 60000 -l 256 -t 1000 -i 1 -m -d 0

```
示例输出
```bash
256 bytes from 10.0.32.172:13579(server2): seq=4984 time=155.076µs
256 bytes from 10.0.32.172:13579(server2): seq=4985 time=149.373µs
256 bytes from 10.0.32.172:13579(server1): seq=4986 time=149.172µs
256 bytes from 10.0.32.172:13579(server2): seq=4987 time=188.161µs
256 bytes from 10.0.32.172:13579(server1): seq=4988 time=147.042µs
256 bytes from 10.0.32.172:13579(server2): seq=4989 time=162.258µs
256 bytes from 10.0.32.172:13579(server1): seq=4990 time=134.791µs
256 bytes from 10.0.32.172:13579(server2): seq=4991 time=193.082µs
256 bytes from 10.0.32.172:13579(server2): seq=4992 time=140.535µs
256 bytes from 10.0.32.172:13579(server2): seq=4993 time=158.263µs
256 bytes from 10.0.32.172:13579(server1): seq=4994 time=209.905µs
256 bytes from 10.0.32.172:13579(server2): seq=4995 time=142.841µs
256 bytes from 10.0.32.172:13579(server2): seq=4996 time=155.149µs
256 bytes from 10.0.32.172:13579(server2): seq=4997 time=139.575µs
256 bytes from 10.0.32.172:13579(server2): seq=4998 time=146.312µs
256 bytes from 10.0.32.172:13579(server1): seq=4999 time=161.93µs

--- 10.0.32.172:13579 uping statistics ---
5000 packets transmitted, 5000 received, 0 packet loss
successful requests rtt avg/max = 199.757µs/8.804277ms, max rtt seq is 3435
lb statistics for each rs name:
server2: 2448 received, rtt avg/max = 202.771µs/8.804277ms, max rtt seq is 3435
server1: 2552 received, rtt avg/max = 199.316µs/6.801022ms, max rtt seq is 3437
```
示例输出,发包端转发组件重启
```bash
read udp 10.0.32.12:56469->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:59043->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:33787->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:38807->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:56996->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:35076->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:52660->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:40473->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:46737->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:55967->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:35684->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:38670->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:43568->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:40471->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:60392->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:52925->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:40567->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:33858->10.0.32.172:13579: i/o timeout
read udp 10.0.32.12:46624->10.0.32.172:13579: i/o timeout
^C
--- 10.0.32.172:13579 uping statistics ---
32984 packets transmitted, 32965 received, 19 packet loss
successful requests rtt avg/max = 183.77µs/11.393629ms, max rtt seq is 12430
estimate network failure time: 19ms
lb statistics for each rs name:
server2: 16404 received, rtt avg/max = 186.256µs/9.765308ms, max rtt seq is 12431
server1: 16561 received, rtt avg/max = 198.136µs/11.393629ms, max rtt seq is 12430
```

# 统计信息

1. 服务端打印收到了客户端的包
2. 客户端每包打印服务端应答
3. 执行结束或者收到 Ctrl+C 信号,打印总体应答统计
4. 应答统计包括： 无应答请求的数量, 平均应答时延, 最大应答时延； 如果有多个 server 应答,打印每个 server 的应答统计

# 杂项

1. 注册信号处理函数,程序退出时打印统计并回收资源
2. 默认改大 socket buffer 的值

# 报文格式

请求报文

```ascii
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          request id                         |m|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                          request seq                          +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                        rest of payload                        +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

说明：

1. 4 字节的请求报文的 request id 通过随机数生成,在一个机器上起多个 client 时,用于区分不同的 client
2. 使用request id的最后一个bit表示客户端是否使用mutable source port
3. 8 字节的序列号,从 0 开始递增,可以不用考虑绕回
4. 剩余负载,内容随机产生,长度 = len(payload) - 12

应答报文

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          request id                         |m|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                          request seq                          +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      server hostname len                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                        server hostname                        +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                        rest of payload                        +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

说明：

1. request id 是从请求报文中读取的,原样写入到应答报文中, 4 字节
2. request seq 是从请求报文中读取的,原样写入应答报文中, 8 字节
3. server hostname len hostname 字段的字节数长度, 4 字节
4. server 的 hostname 字段,本机的 hostname 或者用户填写的值, 变长, 最长不超过 48 字节
5. 剩余负载,内容随机产生,长度 = len(payload) - 16 - len(hostname)
