# 需求

ping 是测试连通性和时延的工具，简单易用, 但有时候我们需要使用 udp 协议，不能用 icmp。

开源工具 nc， iperf，sockperf 等，可以测连通性和 vm2vm 场景的时延, 各有特色，但是都不能适配负载均衡一对多的场景。

自研的工具，cliloop 提供了包长走步测试能力， hpnetgap 提供了测试断网时长的能力。

以上工具在大部分场景其实够用了，但有些场景要求比较苛刻，对工具提出更多要求。

1. 需要能够设置较小的时延参数

2. 需要能 bind 本地地址和端口

3. 需要能够指定探测包长

4. 需要对报文回复数量和时延进行统计

   需要统计: 无应答报文数量是多少， 平均应答时延是多少，最大应答时延是多少。

5. 需要适配 lb 负载均衡场景（一个 client 多个 server）

   有多于一个 server 应答时，需要统计每个 server 应答报文数量是多少，平均应答时延是多少，最大应答时延是多少。

6. 需要做一些基本的系统优化，比如调大 socket buffer 大小适配突发

7. 需要静态编译，方便安装使用

因此开发一个测试工具 uping， 基本功能是测试 udp 连通性，并能够像系统自带的 ping 一样统计 rtt 时延

# 参数

客户端和服务端共享参数

| 参数 | 含义                                                     | 默认值  |
| ---- | -------------------------------------------------------- | ------- |
| -B   | 服务端绑定的地址，服务端可选，客户端必填                 | 0.0.0.0 |
| -P   | bind 本地端口列表，格式 23456,23457                          | 23456   |
| -d   | print level， 0 不打印，1 打印基本信息，2 是打印详细信息 | 1       |
| -h   | 打印帮助信息                                             |         |

服务端独有参数

| 参数 | 含义                                   | 默认值     |
| ---- | -------------------------------------- | ---------- |
| -s   | server 端，否则作为 client             | 服务端必填 |
| -n   | name， 负载均衡场景用于区分多个 server | hostname   |

客户端参数

| 参数 | 含义                                            | 默认值                 |
| ---- | ----------------------------------------------- | ---------------------- |
| -b   | bind 本地地址                                   | 默认 0.0.0.0， 不 bind |
| -p   | bind 本地端口                                   | 默认为 0，随机选择     |
| -l   | length， 负载的长度，最小取值 64 字节以容纳包头 | 64                     |
| -i   | interval, 发包间隔, 单位 ms                     | 100                    |
| -c   | count，发包数量                                 | 10                     |
| -t   | timeout， 一个报文无应答的超时时间，单位 ms     | 1000                   |

examples：

```bash
# 1. 类似ping的简单使用方式, 客户端访问服务端的23456， 23457 接口
./uping -s
./uping -B 127.0.0.1

# server端监听两个端口，并设置名称为server1
./uping -s -B 10.0.32.12 -P 23456,23457 -name server1
./uping -s -B 10.0.32.133 -P 23456,23457 -name server2

# 访问lb监听器的地址和端口，指定报文长度为256， 发送间隔1毫秒
./uping -B 10.0.32.99 -P 12345 -l 256 -i 1 -c 100 -t 100
```

# 统计信息

1. 服务端打印收到了客户端的包
2. 客户端每包打印服务端应答
3. 执行结束或者收到 Ctrl+C 信号，打印总体应答统计
4. 应答统计包括： 无应答请求的数量， 平均应答时延， 最大应答时延； 如果有多个 server 应答，打印每个 server 的应答统计

# 杂项

1. 注册信号处理函数，程序退出时打印统计并回收资源
2. 默认改大 socket buffer 的值

# 报文格式

请求报文

```ascii
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           request id                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                          request seq                          +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                        rest of payload                        +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

说明：

1. 4 字节的请求报文的 request id 通过随机数生成，在一个机器上起多个 client 时，用于区分不同的 client
2. 8 字节的序列号，从 0 开始递增，可以不用考虑绕回
3. 剩余负载，内容随机产生，长度 = len(payload) - 12

应答报文

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           request id                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                          request seq                          +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      server hostname len                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                        server hostname                        +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                        rest of payload                        +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

说明：

1. request id 是从请求报文中读取的，原样写入到应答报文中， 4 字节
2. request seq 是从请求报文中读取的，原样写入应答报文中， 8 字节
3. server hostname len hostname 字段的字节数长度， 4 字节
4. server 的 hostname 字段，本机的 hostname 或者用户填写的值， 变长， 最长不超过 48 字节
5. 剩余负载，内容随机产生，长度 = len(payload) - 16 - len(hostname)
